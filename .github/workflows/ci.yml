name: CI
on:
  push:
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Lint
        run: |
          ruff check .
          ruff format --check .

  contract-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Contract tests
        run: pytest -q tests/test_server_http_contract.py tests/test_validation.py tests/test_github_connector_api.py

  reliability-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Reliability tests
        run: pytest -q tests/test_runbook_scenarios.py

  regression-fixtures:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Regression fixtures
        run: pytest -q tests/test_golden_issue_fixtures.py tests/test_reporting.py

  docs-command-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Docs command validation
        run: pytest -q tests/test_docs_commands.py

  frontend-unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install frontend deps
        working-directory: ui
        run: npm install
      - name: Frontend unit tests
        working-directory: ui
        run: npm test

  frontend-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install frontend deps
        working-directory: ui
        run: npm install
      - name: Install Playwright browser
        working-directory: ui
        run: npx playwright install chromium --with-deps
      - name: Frontend e2e tests
        working-directory: ui
        run: npm run test:e2e

  docker-validation:
    runs-on: ubuntu-latest
    env:
      DOCKER_SMOKE_BUILD: "0"
    steps:
      - uses: actions/checkout@v4
      - id: paths
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docker:
              - 'docker-compose.yml'
              - 'Dockerfile'
              - '.dockerignore'
              - 'ui/Dockerfile'
              - 'ui/.dockerignore'
              - 'README.md'
              - '.github/workflows/ci.yml'
      - name: Validate Docker Compose config
        if: github.event_name != 'pull_request' || steps.paths.outputs.docker == 'true'
        run: docker compose config
      - name: Docker Compose smoke build (optional)
        if: (github.event_name != 'pull_request' || steps.paths.outputs.docker == 'true') && env.DOCKER_SMOKE_BUILD == '1'
        run: docker compose build

  release-gate:
    runs-on: ubuntu-latest
    needs:
      - lint
      - contract-tests
      - reliability-tests
      - regression-fixtures
      - docs-command-validation
      - frontend-unit-tests
      - frontend-e2e
      - docker-validation
    steps:
      - name: QA matrix release gate
        run: |
          echo "Release gate passed: QA matrix checks are green."
